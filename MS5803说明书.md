# MS5803传感器说明书（微型变量计模块）

本传感器是第二届FPGA邀请赛用。

## 1.规格说明

本传感器在3V电源供电的情况下，参数如下：

| 压力     | 最小 | 典型值                               | 最大 | 单位              |
| -------- | ---- | ------------------------------------ | ---- | ----------------- |
| 范围     | 10   |                                      | 1300 | mbar(1mbar=100pa) |
| ADC      |      | 24                                   |      | bit               |
| 分辨率   |      | 0.065 / 0.042 / 0.027/ 0.018 / 0.012 |      | mbar              |
| 反应时间 |      | 0.5 / 1.1 / 2.1 / 4.1 /8.22          |      | ms                |

| 温度   | 最小 | 典型值 | 最大 | 单位 |
| ------ | ---- | ------ | ---- | ---- |
| 范围   | -40  |        | 85   | 度   |
| 分辨率 |      | 0.01   |      | 度   |

### 功能框图

![QQ截图20200125220923](D:\学习资料\Markdown_photo\QQ截图20200125220923.png)

## 2.主要参数

### （1）采样率

这里必须提到一个参数：OSR，即过采样率

根据奈奎斯特采样定理，如果采样时钟为fs，信号带宽为fn=fs/2，此时如果我们想提高性能，就需要采用比奈奎斯特频率小的带宽，即fB。当信号带宽为fB，我们就定义过采样率OSR＝fs/fB。

| 参数     | OSR（过采样率） | 最小 | 典型值 | 最大 | 单位 |
| -------- | --------------- | ---- | ------ | ---- | ---- |
| 转换时间 | 4096            | 7.40 | 8.22   | 9.04 | ms   |
| 转换时间 | 2048            | 3.72 | 4.13   | 4.54 | ms   |
| 转换时间 | 1024            | 1.88 | 2.08   | 2.28 | ms   |
| 转换时间 | 512             | 0.95 | 1.06   | 1.17 | ms   |
| 转换时间 | 256             | 0.48 | 0.54   | 0.60 | ms   |

这里可以看出，当OSR为256时，我们的转换时间可以低至0.54ms,也就是采样频率达到约1851HZ，这是高速度的采样频率。



### （2）两种协议参数（I2C和SPI）

| 参数                     | 符号 | 状态    | 最小 | 典型值 | 最大 | 单位 |
| ------------------------ | ---- | ------- | ---- | ------ | ---- | ---- |
| 串行数据时钟             | SCLK | SPI协议 |      |        | 20   | MHz  |
| 串行数据时钟             | SCL  | I2C协议 |      |        | 400  | kHz  |
| CS低至第一个SCLK上升     | tCSL |         | 21   |        |      | ns   |
| 从最后一个SCLK下降到CS低 | tCSH |         | 21   |        |      | ns   |

表里主要说明的是两种协议的最大时钟频率和协议内电平升降时间。



## 3.功能描述

### （1）总体描述

MS5803-01BA包括一个压阻传感器和一个传感器IC接口。 MS5803-01BA的主要功能是将来自压阻式压力传感器的未补偿模拟输出电压转换为24位数字值，并为传感器温度提供24位数字值。



### （2）出厂校准

每个模块都在两个温度和两个压力下分别进行了出厂校准。我们需要计算出补偿工艺变化和温度变化所需的6个系数，并将其存储在每个模块的128位PROM中。 这些位（分为6个系数W1至W6）必须由微控制器软件读取，并在将D1和D2转换为补偿的压力和温度值的程序中使用。2个系数W0和W7用于工厂配置和CRC。



### （3）串口选择

MS5803-01BA内置了两种类型的串行接口：SPI和I2C。将协议选择引脚PS拉至低电平将选择SPI协议，将PS拉至高电平将激活I2C总线协议。

| PS引脚选择（电平） | 模式 | 会用到的引脚        |
| ------------------ | ---- | ------------------- |
| 高                 | I2C  | SDA, SCL, CSB       |
| 低                 | SPI  | SDI, SDO, SCLK, CSB |



由于具体使用下只使用了I2C协议，这里只介绍I2C的内容。

### （4）I2C模式

外部微控制器通过输入SCLK（Serial CLocK）和SDA（Serial DAta）输入数据时钟。传感器在同一引脚SDA上做出响应，该引脚对于I2C总线接口是双向的。因此，此接口类型仅使用2条信号线，并且不需要芯片选择。在I2C模式下，引脚CSB（Chip Select）的补码表示I2C地址的LSB。可以在I2C总线上使用两个具有两个不同地址的传感器。 CSB引脚应连接至VDD或GND（请勿断开连接！）。

| CSB引脚 | 地址（7 bits）   |
| ------- | ---------------- |
| 高      | 0x76 (1110110 b) |
| 低      | 0x77 (1110111 b) |



### （5）命令

MS5803-01BA只有五个基本命令：

1. 复位
2. 读取PROM（128位校准字）

3. D1转换

4. D2转换

5. 读取ADC结果（24位压力/温度）

  

每个命令的大小为1个字节（8位），如下表所述。 ADC读取命令后，器件将返回24位结果，而PROM读取16位结果后。 PROM的地址使用a2，a1和a0位嵌入到PROM读取命令中。

#### 下面介绍具体的指令使用。



![QQ截图20200126133946](D:\学习资料\Markdown_photo\QQ截图20200126133946.png)

### （6）压力和温度计算

下面的表中提及了出厂校准里的系数。

#### 读取PROM里的校准系数

| 符号 | 符号     | 位数 |           | 典型值 |
| ---- | -------- | ---- | --------- | ------ |
| C1   | SENST1   | 16   | [0,65535] | 40127  |
| C2   | OFFT1    | 16   | [0,65535] | 36924  |
| C3   | TCS      | 16   | [0,65535] | 23317  |
| C4   | TCO      | 16   | [0,65535] | 23282  |
| C5   | TREF     | 16   | [0,65535] | 33464  |
| C6   | TEMPSENS | 16   | [0,65535] | 28312  |



#### 读取转化后的压力和温度值

| 符号 | 含义 | 位数 |              | 典型值  |
| ---- | ---- | ---- | ------------ | ------- |
| D1   | 压力 | 24   | [0,16777216] | 9085466 |
| D2   | 温度 | 24   | [0,16777216] | 8569150 |



#### 计算温度

| 符号 | 公式                          | 位数 | 范围                 | 典型值         |
| ---- | ----------------------------- | ---- | -------------------- | -------------- |
| dT   | dT = D2 - C5 * 2^8            | 25   | [-16776960,16777216] | 2366           |
| TEMP | TEMP =  2000 + dT * C6 / 2^23 | 41   | [-4000,8500]         | 2007= 20.07 °C |



#### 计算压力

| 符号 | 公式                                  | 位数 | 范围                      | 典型值                    |
| ---- | ------------------------------------- | ---- | ------------------------- | ------------------------- |
| OFF  | OFF = C2 * 2^16+ (C4 * dT )/ 2^7      | 41   | [-8589672450,12884705280] | 2420281617                |
| SENS | SENS = C1 * 2 ^15+ (C3 * dT )/ 2^8    | 41   | [-4294836225,6442352640]  | 1315097036                |
| P    | P = (D1 * SENS / 2 ^21 - OFF) / 2 ^15 | 58   | [1000,130000]             | 100009<br/>= 1000.09 mbar |



#### 二阶温度补偿

当温度较低或者较高时，需要进行二阶温度补偿进行修正。

#### ![QQ截图20200126141538](D:\学习资料\Markdown_photo\QQ截图20200126141538.png)

### （7）I2C时序说明

#### 指令

每个I2C通信消息均以开始条件开始，并以停止条件结束。 MS5803-01BA地址为111011Cx，其中C是引脚CSB的互补值。 由于IC内部没有微控制器，因此I2C和SPI的命令非常相似。



#### 复位序列

复位可以随时发送。 如果没有成功的上电复位，则可能是由于SDA被处于确认状态的模块阻塞所致。 使MS5803-01BA正常运行的唯一方法是发送多个SCLK，后跟一个复位序列或重复上电复位。

![QQ截图20200126144005](D:\学习资料\Markdown_photo\QQ截图20200126144005.png)

可以看到，发送复位指令由两部分构成，首先写从机地址111011C0，等待从机响应一位，然后再发送复位指令00011110，等待从机响应一位后发送停止信号。



#### 转换序列

可以通过将命令发送到MS5803-01BA开始转换。当命令发送到系统时，它将保持忙碌状态直到完成转换。转换完成后，可以通过发送读取命令来访问数据，当MS5803-01BA出现确认时，可以发送24个SCLK周期以接收所有结果位。系统每8位等待一个确认信号。

![QQ截图20200126145304](D:\学习资料\Markdown_photo\QQ截图20200126145304.png)

图13中是写OSR=4096，D1时的初始化命令。

![QQ截图20200126145321](D:\学习资料\Markdown_photo\QQ截图20200126145321.png)

![QQ截图20200126145332](D:\学习资料\Markdown_photo\QQ截图20200126145332.png)

图15是从机回应输出的24位数据，对应D1,D2。



#### PROM读序列

PROM读序列由两部分组成。第一部分将系统设置为PROM读取模式。第二部分从系统获取数据。

![QQ截图20200126170656](D:\学习资料\Markdown_photo\QQ截图20200126170656.png)

图12是从机回应读取的16位数据，对应C1-C6。